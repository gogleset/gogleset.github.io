<!DOCTYPE html><html lang="ko" data-theme="cupcake"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="https://gogleset.github.io/_next/static/css/cc4162795b3fa97e.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="https://gogleset.github.io/_next/static/chunks/webpack-14f60f031ad37603.js"/><script src="https://gogleset.github.io/_next/static/chunks/fd9d1056-e158016523ed90e0.js" async=""></script><script src="https://gogleset.github.io/_next/static/chunks/23-45bdff8afeaaa1ce.js" async=""></script><script src="https://gogleset.github.io/_next/static/chunks/main-app-c91a41629f488782.js" async=""></script><script src="https://gogleset.github.io/_next/static/chunks/231-e841b6edcc38d627.js" async=""></script><script src="https://gogleset.github.io/_next/static/chunks/app/posts/%5Bid%5D/error-43f6426e3a7526c8.js" async=""></script><script src="https://gogleset.github.io/_next/static/chunks/app/layout-c5dcdd748a4b65d7.js" async=""></script><script src="https://gogleset.github.io/_next/static/chunks/app/global-error-9622828abc1b57c8.js" async=""></script><script src="https://gogleset.github.io/_next/static/chunks/173-085cf89c21a1457b.js" async=""></script><script src="https://gogleset.github.io/_next/static/chunks/app/posts/%5Bid%5D/page-ed3992e816e0c12e.js" async=""></script><link rel="preload" href="https://www.googletagmanager.com/gtag/js?id=undefined" as="script"/><title>Next.js Image 어떻게 최적화 할까?</title><meta name="description" content="Image 최적화 과정과 Canary 버전에서 확인해보는 신기능?도 있었다."/><meta name="keywords" content="gogleset,Next,Image"/><meta property="og:title" content="Next.js Image 어떻게 최적화 할까?"/><meta property="og:description" content="Image 최적화 과정과 Canary 버전에서 확인해보는 신기능?도 있었다."/><meta property="og:site_name" content="https://gogleset.github.io"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Next.js Image 어떻게 최적화 할까?"/><meta name="twitter:description" content="Image 최적화 과정과 Canary 버전에서 확인해보는 신기능?도 있었다."/><link rel="icon" href="/favicon-32x32.png"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><script src="https://gogleset.github.io/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body><header class=" border-gray-200 px-4 lg:px-6 py-3.5  max-h-[68px] w-full sticky top-0 bg-base-100"><div class="w-full max-w-[1140px] mx-auto"><div class="flex flex-wrap justify-between items-center "><div class="flex gap-3 items-center"><a class="self-center text-xl font-semibold whitespace-nowrap cursor-pointer" href="/">gogleset&#x27;s note</a><div class="divider divider-horizontal w-2 max-lg:hidden"></div><nav class="max-lg:hidden"><ul class="flex  gap-3 "><li class="self-center text-lg font-semibold whitespace-nowrap cursor-pointer"><a href="/about">About</a></li><li class="self-center text-lg font-semibold whitespace-nowrap cursor-pointer"><a href="/tags">Tags</a></li></ul></nav></div><div class="flex gap-4 items-center justify-center"><div class="flex max-lg:hidden"><label class="swap "><input type="checkbox"/><svg class="swap-off fill-current w-10 h-10" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"></path></svg><svg class="swap-on fill-current w-10 h-10" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"></path></svg></label></div><div class="drawer drawer-end lg:hidden"><input id="my-drawer-3" type="checkbox" class="drawer-toggle"/><div class="drawer-content flex flex-col"><div class=" w-full p-0"><div class="lg:hidden"><label for="my-drawer-3" aria-label="open sidebar" class="cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></label></div></div></div><div class="drawer-side"><label for="my-drawer-3" aria-label="close sidebar" class="drawer-overlay"></label><div class="menu p-4 w-80 min-h-full bg-base-200 justify-between"><ul class="flex flex-col gap-3 "><li class="self-center text-lg font-semibold whitespace-nowrap cursor-pointer"><a href="/about">About</a></li><li class="self-center text-lg font-semibold whitespace-nowrap cursor-pointer"><a href="/tags">Tags</a></li></ul><div class="flex justify-between"><svg class="fill-current cursor-pointer" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 512 512"><polygon points="400 145.49 366.51 112 256 222.51 145.49 112 112 145.49 222.51 256 112 366.51 145.49 400 256 289.49 366.51 400 400 366.51 289.49 256 400 145.49"></polygon></svg><label class="swap "><input type="checkbox"/><svg class="swap-off fill-current w-10 h-10" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"></path></svg><svg class="swap-on fill-current w-10 h-10" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"></path></svg></label></div></div></div></div></div></div><progress class="progress progress-primary w-full backdrop-blur-[10px]" value="0" max="100"></progress></div></header><main class="flex w-full justify-center items-center flex-col"><article class="flex justify-center w-full max-w-[1080px] p-5"><!--$--><div class="flex flex-col w-full"><div class="flex flex-col items-center justify-center h-64 gap-3"><h1 class="text-3xl max-lg:text-2xl font-bold text-center">Next.js Image 어떻게 최적화 할까?</h1><div class="flex flex-col items-center justify-center gap-1"><span class="text-gray">2025-04-20</span><div class="flex gap-1 "><span class="badge badge-accent">Next</span><span class="badge badge-accent">Image</span></div></div></div><hr class="mb-[0px]"/><div class="flex flex-col prose max-w-full max-sm:prose-sm "><ul>
<li>2025.4 Next.js canary ver</li>
</ul>
<h1 id="toc">toc</h1>
<ul>
<li><a href="#%EC%84%A0%ED%98%95%EC%A0%81%EC%9C%BC%EB%A1%9C-%EB%82%98%ED%83%80%EB%82%B8-nextjs-image-%ED%98%B8%EC%B6%9C">선형적으로 나타낸 Next.js Image 호출</a></li>
<li><a href="#request%EC%9D%98-%EC%B2%98%EB%A6%AC">Request의 처리</a></li>
<li><a href="#%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%B5%9C%EC%A0%81%ED%99%94-%ED%95%A0%EA%B9%8C">어떻게 최적화 할까?</a>
<ul>
<li><a href="#1-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%B5%9C%EC%A0%81%ED%99%94%EC%9A%A9%EB%9F%89-%EC%A4%84%EC%9D%B4%EA%B8%B0">1. 이미지 최적화(용량 줄이기)</a>
<ul>
<li><a href="#optimizeimage">optimizeImage</a></li>
<li><a href="#imageoptimizer">imageOptimizer</a></li>
</ul>
</li>
<li><a href="#2-%EC%BA%90%EC%8B%B1">2. 캐싱</a></li>
</ul>
</li>
</ul>
<h1 id="선형적으로-나타낸-nextjs-image-호출">선형적으로 나타낸 Next.js Image 호출</h1>
<ul>
<li>사용자 브라우저가 <code>/_next/image/...</code> 경로로 이미지 요청을 보냄</li>
<li>Next.js 서버에서 해당 요청이 <code>handleNextImageRequest</code> 핸들러로 라우팅</li>
<li>이 핸들러는 요청이 <code>/_next/image</code>로 시작하는지 확인하고, 유효한 이미지 요청인지 파라미터를 검증</li>
<li>이미지 캐시를 확인하여 이미 최적화된 이미지가 있는지 확인</li>
<li>캐시에 없다면 <code>imageOptimizer</code> 메서드를 통해 이미지를 실제로 최적화</li>
<li>최적화된 이미지를 응답으로 반환하고 캐시에 저장</li>
</ul>
<h1 id="request의-처리">Request의 처리</h1>
<pre class="language-ts"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L711-L760</span>
</span><span class="code-line"><span class="token keyword">protected</span> handleNextImageRequest<span class="token operator">:</span> <span class="token function-variable function">NodeRouteHandler</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
</span><span class="code-line">    req<span class="token punctuation">,</span>
</span><span class="code-line">    res<span class="token punctuation">,</span>
</span><span class="code-line">    parsedUrl
</span><span class="code-line">  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token comment">// URL 경로가 없거나 &#x27;/_next/image&#x27;로 시작하지 않으면 이 핸들러에서 처리하지 않음</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parsedUrl<span class="token punctuation">.</span>pathname <span class="token operator">||</span> <span class="token operator">!</span>parsedUrl<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#x27;/_next/image&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token keyword">return</span> <span class="token boolean">false</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">    <span class="token comment">// 미들웨어 요청이면 처리하지 않음</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getRequestMeta</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token string">&#x27;middlewareInvoke&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token keyword">return</span> <span class="token boolean">false</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// 최소 모드이거나 정적 내보내기 모드일 경우 이미지 최적화를 처리하지 않고 400 오류 반환</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>
</span><span class="code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>minimalMode <span class="token operator">||</span>
</span><span class="code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>nextConfig<span class="token punctuation">.</span>output <span class="token operator">===</span> <span class="token string">&#x27;export&#x27;</span> <span class="token operator">||</span>
</span><span class="code-line">      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NEXT_MINIMAL</span>
</span><span class="code-line">    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">      res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">400</span>
</span><span class="code-line">      res<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&#x27;Bad Request&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token keyword">return</span> <span class="token boolean">true</span>
</span><span class="code-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token comment">// 이미지 최적화 캐시 모듈 불러오기</span>
</span><span class="code-line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> ImageOptimizerCache <span class="token punctuation">}</span> <span class="token operator">=</span>
</span><span class="code-line">        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./image-optimizer&#x27;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#x27;./image-optimizer&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token comment">// 이미지 최적화 캐시 인스턴스 생성(이때 경로가 캐시 경로가 생성된다)</span>
</span><span class="code-line">      <span class="token keyword">const</span> imageOptimizerCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageOptimizerCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">        distDir<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>distDir<span class="token punctuation">,</span>
</span><span class="code-line">        nextConfig<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextConfig<span class="token punctuation">,</span>
</span><span class="code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token comment">// 이미지 응답 처리 유틸리티 불러오기</span>
</span><span class="code-line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> sendResponse<span class="token punctuation">,</span> ImageError <span class="token punctuation">}</span> <span class="token operator">=</span>
</span><span class="code-line">        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./image-optimizer&#x27;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#x27;./image-optimizer&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token comment">// 이미지 응답 캐시가 초기화되지 않았으면 오류 발생(확실치 않음)</span>
</span><span class="code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>imageResponseCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;invariant image optimizer cache was not initialized&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token punctuation">}</span>
</span><span class="code-line">      <span class="token keyword">const</span> imagesConfig <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextConfig<span class="token punctuation">.</span>images
</span><span class="code-line">
</span><span class="code-line">      <span class="token comment">// 기본 로더가 아니거나 최적화를 사용하지 않도록 설정된 경우 404 반환</span>
</span><span class="code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>imagesConfig<span class="token punctuation">.</span>loader <span class="token operator">!==</span> <span class="token string">&#x27;default&#x27;</span> <span class="token operator">||</span> imagesConfig<span class="token punctuation">.</span>unoptimized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render404</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token keyword">return</span> <span class="token boolean">true</span>
</span><span class="code-line">      <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token comment">// 요청 파라미터 유효성 검사</span>
</span><span class="code-line">      <span class="token keyword">const</span> paramsResult <span class="token operator">=</span> ImageOptimizerCache<span class="token punctuation">.</span><span class="token function">validateParams</span><span class="token punctuation">(</span>
</span><span class="code-line">        req<span class="token punctuation">.</span>originalRequest<span class="token punctuation">,</span>
</span><span class="code-line">        parsedUrl<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
</span><span class="code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>nextConfig<span class="token punctuation">,</span>
</span><span class="code-line">        <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderOpts<span class="token punctuation">.</span>dev
</span><span class="code-line">      <span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token comment">// 파라미터가 유효하지 않으면 400 오류 반환</span>
</span><span class="code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#x27;errorMessage&#x27;</span> <span class="token keyword">in</span> paramsResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">        res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">400</span>
</span><span class="code-line">        res<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>paramsResult<span class="token punctuation">.</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token keyword">return</span> <span class="token boolean">true</span>
</span><span class="code-line">      <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token comment">// 캐시 키 생성</span>
</span><span class="code-line">      <span class="token keyword">const</span> cacheKey <span class="token operator">=</span> ImageOptimizerCache<span class="token punctuation">.</span><span class="token function">getCacheKey</span><span class="token punctuation">(</span>paramsResult<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token keyword">try</span> <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token comment">// 파일 확장자 추출 유틸리티 불러오기</span>
</span><span class="code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> getExtension <span class="token punctuation">}</span> <span class="token operator">=</span>
</span><span class="code-line">          <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./serve-static&#x27;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#x27;./serve-static&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">        <span class="token comment">// 이미지 응답 캐시에서 결과 가져오기, 없으면 생성</span>
</span><span class="code-line">        <span class="token keyword">const</span> cacheEntry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>imageResponseCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
</span><span class="code-line">          cacheKey<span class="token punctuation">,</span>
</span><span class="code-line">          <span class="token comment">// responseGenerator</span>
</span><span class="code-line">          <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> previousCacheEntry <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line">            <span class="token comment">// 이미지 최적화 실행</span>
</span><span class="code-line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> buffer<span class="token punctuation">,</span> contentType<span class="token punctuation">,</span> maxAge<span class="token punctuation">,</span> upstreamEtag<span class="token punctuation">,</span> etag <span class="token punctuation">}</span> <span class="token operator">=</span>
</span><span class="code-line">	            <span class="token comment">// 없다면 실행해서 _next/image로 이미지 캐싱</span>
</span><span class="code-line">              <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">imageOptimizer</span><span class="token punctuation">(</span>
</span><span class="code-line">                req<span class="token punctuation">,</span>
</span><span class="code-line">                res<span class="token punctuation">,</span>
</span><span class="code-line">                paramsResult<span class="token punctuation">,</span>
</span><span class="code-line">                previousCacheEntry
</span><span class="code-line">              <span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">            <span class="token comment">// 캐시 엔트리 반환</span>
</span><span class="code-line">            <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line">              value<span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">                kind<span class="token operator">:</span> CachedRouteKind<span class="token punctuation">.</span><span class="token constant">IMAGE</span><span class="token punctuation">,</span>
</span><span class="code-line">                buffer<span class="token punctuation">,</span>
</span><span class="code-line">                etag<span class="token punctuation">,</span>
</span><span class="code-line">                extension<span class="token operator">:</span> <span class="token function">getExtension</span><span class="token punctuation">(</span>contentType<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
</span><span class="code-line">                upstreamEtag<span class="token punctuation">,</span>
</span><span class="code-line">              <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">              isFallback<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
</span><span class="code-line">              cacheControl<span class="token operator">:</span> <span class="token punctuation">{</span> revalidate<span class="token operator">:</span> maxAge<span class="token punctuation">,</span> expire<span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">            <span class="token punctuation">}</span>
</span><span class="code-line">          <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">          <span class="token punctuation">{</span>
</span><span class="code-line">            routeKind<span class="token operator">:</span> RouteKind<span class="token punctuation">.</span><span class="token constant">IMAGE</span><span class="token punctuation">,</span>
</span><span class="code-line">            incrementalCache<span class="token operator">:</span> imageOptimizerCache<span class="token punctuation">,</span>
</span><span class="code-line">            isFallback<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
</span><span class="code-line">          <span class="token punctuation">}</span>
</span><span class="code-line">        <span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">        <span class="token comment">// 캐시 결과가 이미지 종류가 아니면 오류 발생</span>
</span><span class="code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheEntry<span class="token operator">?.</span>value<span class="token operator">?.</span>kind <span class="token operator">!==</span> CachedRouteKind<span class="token punctuation">.</span><span class="token constant">IMAGE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
</span><span class="code-line">            <span class="token string">&#x27;invariant did not get entry from image response cache&#x27;</span>
</span><span class="code-line">          <span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">        <span class="token comment">// 응답 전송</span>
</span><span class="code-line">        <span class="token function">sendResponse</span><span class="token punctuation">(</span>
</span><span class="code-line">          req<span class="token punctuation">.</span>originalRequest<span class="token punctuation">,</span>
</span><span class="code-line">          res<span class="token punctuation">.</span>originalResponse<span class="token punctuation">,</span>
</span><span class="code-line">          paramsResult<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
</span><span class="code-line">          cacheEntry<span class="token punctuation">.</span>value<span class="token punctuation">.</span>extension<span class="token punctuation">,</span>
</span><span class="code-line">          cacheEntry<span class="token punctuation">.</span>value<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
</span><span class="code-line">          cacheEntry<span class="token punctuation">.</span>value<span class="token punctuation">.</span>etag<span class="token punctuation">,</span>
</span><span class="code-line">          paramsResult<span class="token punctuation">.</span>isStatic<span class="token punctuation">,</span>
</span><span class="code-line">          cacheEntry<span class="token punctuation">.</span>isMiss <span class="token operator">?</span> <span class="token string">&#x27;MISS&#x27;</span> <span class="token operator">:</span> cacheEntry<span class="token punctuation">.</span>isStale <span class="token operator">?</span> <span class="token string">&#x27;STALE&#x27;</span> <span class="token operator">:</span> <span class="token string">&#x27;HIT&#x27;</span><span class="token punctuation">,</span> <span class="token comment">// 캐시 상태 표시</span>
</span><span class="code-line">          imagesConfig<span class="token punctuation">,</span>
</span><span class="code-line">          cacheEntry<span class="token punctuation">.</span>cacheControl<span class="token operator">?.</span>revalidate <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
</span><span class="code-line">          <span class="token function">Boolean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderOpts<span class="token punctuation">.</span>dev<span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token keyword">return</span> <span class="token boolean">true</span>
</span><span class="code-line">      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token comment">// 이미지 관련 오류인 경우 해당 상태 코드와 메시지 반환</span>
</span><span class="code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">ImageError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">          res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> err<span class="token punctuation">.</span>statusCode
</span><span class="code-line">          res<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">          <span class="token keyword">return</span> <span class="token boolean">true</span>
</span><span class="code-line">        <span class="token punctuation">}</span>
</span><span class="code-line">        <span class="token comment">// 그 외 오류는 상위로 전파</span>
</span><span class="code-line">        <span class="token keyword">throw</span> err
</span><span class="code-line">      <span class="token punctuation">}</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>이미지 저장과 최적화가 이루어지고 있는 함수이다.</li>
<li>맨 처음 Request를 받으면 실행되는 로직이다.</li>
</ul>
<h1 id="어떻게-최적화-할까">어떻게 최적화 할까?</h1>
<h2 id="1-이미지-최적화용량-줄이기">1. 이미지 최적화(용량 줄이기)</h2>
<p>/next/src/server/image-optimizer.ts</p>
<pre class="language-ts"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">const</span> <span class="token constant">AVIF</span> <span class="token operator">=</span> <span class="token string">&quot;image/avif&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token constant">WEBP</span> <span class="token operator">=</span> <span class="token string">&quot;image/webp&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token constant">PNG</span> <span class="token operator">=</span> <span class="token string">&quot;image/png&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token constant">JPEG</span> <span class="token operator">=</span> <span class="token string">&quot;image/jpeg&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token constant">GIF</span> <span class="token operator">=</span> <span class="token string">&quot;image/gif&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token constant">SVG</span> <span class="token operator">=</span> <span class="token string">&quot;image/svg+xml&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token constant">ICO</span> <span class="token operator">=</span> <span class="token string">&quot;image/x-icon&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token constant">ICNS</span> <span class="token operator">=</span> <span class="token string">&quot;image/x-icns&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token constant">TIFF</span> <span class="token operator">=</span> <span class="token string">&quot;image/tiff&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token constant">BMP</span> <span class="token operator">=</span> <span class="token string">&quot;image/bmp&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token constant">ANIMATABLE_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant">WEBP</span><span class="token punctuation">,</span> <span class="token constant">PNG</span><span class="token punctuation">,</span> <span class="token constant">GIF</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 움직일만한 타입(PNG는 APNG라는 포맷이 있다.)</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token constant">BYPASS_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant">SVG</span><span class="token punctuation">,</span> <span class="token constant">ICO</span><span class="token punctuation">,</span> <span class="token constant">ICNS</span><span class="token punctuation">,</span> <span class="token constant">BMP</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 최적화 안해주는 타입들</span>
</span></code></pre>
<ul>
<li>Next.js가 관리하고 있는 image 속성값들이다.</li>
</ul>
<pre class="language-ts"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L711-L760</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// buffer에서 뽑은 contentType이나, imageUpstream이라는 Props로 받은 타입</span>
</span><span class="code-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>upstreamType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token comment">// 요청된 이미지가 SVG 형식이고, 설정에서 SVG 허용이 비활성화되어 있다면 에러 처리</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>
</span><span class="code-line">    upstreamType<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;image/svg&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
</span><span class="code-line">    <span class="token operator">!</span>nextConfig<span class="token punctuation">.</span>images<span class="token punctuation">.</span>dangerouslyAllowSVG
</span><span class="code-line">  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    Log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
</span><span class="code-line">      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The requested resource &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; has type &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>upstreamType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; but dangerouslyAllowSVG is disabled</span><span class="token template-punctuation string">`</span></span>
</span><span class="code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ImageError</span><span class="token punctuation">(</span>
</span><span class="code-line">      <span class="token number">400</span><span class="token punctuation">,</span>
</span><span class="code-line">      <span class="token string">&#x27;&quot;url&quot; parameter is valid but image type is not allowed&#x27;</span>
</span><span class="code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// 요청된 이미지가 애니메이션 가능한 타입이며 실제로 애니메이션 이미지라면, 최적화하지 않고 원본 반환</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">ANIMATABLE_TYPES</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>upstreamType<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isAnimated</span><span class="token punctuation">(</span>upstreamBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    Log<span class="token punctuation">.</span><span class="token function">warnOnce</span><span class="token punctuation">(</span>
</span><span class="code-line">      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The requested resource &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is an animated image so it will not be optimized. Consider adding the &quot;unoptimized&quot; property to the &lt;Image&gt;.</span><span class="token template-punctuation string">`</span></span>
</span><span class="code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token punctuation">{</span> buffer<span class="token operator">:</span> upstreamBuffer<span class="token punctuation">,</span> contentType<span class="token operator">:</span> upstreamType<span class="token punctuation">,</span> maxAge <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// 벡터 이미지일 경우 (ex. image/svg+xml), 원본 반환</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">VECTOR_TYPES</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>upstreamType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token comment">// 이 경우에는 이미 dangerouslyAllowSVG를 통해 허용된 상태이므로 별도 경고 없이 반환</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token punctuation">{</span> buffer<span class="token operator">:</span> upstreamBuffer<span class="token punctuation">,</span> contentType<span class="token operator">:</span> upstreamType<span class="token punctuation">,</span> maxAge <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// BYPASS_TYPES에 등록되어 있는경우</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">BYPASS_TYPES</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>upstreamType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line">      buffer<span class="token operator">:</span> upstreamBuffer<span class="token punctuation">,</span>
</span><span class="code-line">      contentType<span class="token operator">:</span> upstreamType<span class="token punctuation">,</span>
</span><span class="code-line">      maxAge<span class="token punctuation">,</span>
</span><span class="code-line">      etag<span class="token operator">:</span> upstreamEtag<span class="token punctuation">,</span>
</span><span class="code-line">      upstreamEtag<span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token comment">// 이미지 형식이 아니거나 잘못된 형식일 경우 에러 처리</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>upstreamType<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;image/&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> upstreamType<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    Log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
</span><span class="code-line">      <span class="token string">&quot;The requested resource isn&#x27;t a valid image for&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">      href<span class="token punctuation">,</span>
</span><span class="code-line">      <span class="token string">&quot;received&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">      upstreamType
</span><span class="code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ImageError</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&quot;The requested resource isn&#x27;t a valid image.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>svg, dangerouslyAllowSVG option을 썼을때, WEBP, PNG, GIF,애니메이션이 들어갔다면 최적화를 하지 않는다. BYPASS_TYPES에 등록되어 있는경우와 그 이외에 unoptimized 옵션을 썼을때도 마찬가지다.</li>
</ul>
<p>그 다음 로직이다.</p>
<pre class="language-ts"><code class="language-ts code-highlight"><span class="code-line"> <span class="token comment">//  https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L762-L775</span>
</span><span class="code-line"> <span class="token keyword">let</span> contentType<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>mimeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    contentType <span class="token operator">=</span> mimeType
</span><span class="code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
</span><span class="code-line">    upstreamType<span class="token operator">?.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#x27;image/&#x27;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
</span><span class="code-line">    <span class="token function">getExtension</span><span class="token punctuation">(</span>upstreamType<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// =&gt; &#x27;jpeg&#x27;, &#x27;webp&#x27;, &#x27;avif&#x27;</span>
</span><span class="code-line">    upstreamType <span class="token operator">!==</span> <span class="token constant">WEBP</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// &#x27;image/webp&#x27;</span>
</span><span class="code-line">    upstreamType <span class="token operator">!==</span> <span class="token constant">AVIF</span> <span class="token comment">// &#x27;image/avif&#x27;</span>
</span><span class="code-line">  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    contentType <span class="token operator">=</span> upstreamType <span class="token comment">// 원본 이미지의 buffer에서 추출한 값이나 이미지 메타정보의 contentType</span>
</span><span class="code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
</span><span class="code-line">    contentType <span class="token operator">=</span> <span class="token constant">JPEG</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>contentType을 결정하는데<!-- -->
<ul>
<li>mimeType이 있다면 contentType을 mimeType으로 할당한다.</li>
<li>이미지 메타정보가 image/로 시작하거나, getExtension 함수에서 반환값이 있거나, webp가 아니거나, avif가 아닐 경우엔, upstreamType을 쓰는데 buffer에서 추출한 값이나 이미지 메타정보의 contentType이 할당된다.</li>
<li>나머지는 JPEG로 할당된다.</li>
</ul>
</li>
</ul>
<pre class="language-ts"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L776-L788</span>
</span><span class="code-line"><span class="token keyword">const</span> previouslyCachedImage <span class="token operator">=</span> <span class="token function">getPreviouslyCachedImageOrNull</span><span class="token punctuation">(</span>
</span><span class="code-line">  imageUpstream<span class="token punctuation">,</span>
</span><span class="code-line">  opts<span class="token punctuation">.</span>previousCacheEntry
</span><span class="code-line"><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>previouslyCachedImage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line">    buffer<span class="token operator">:</span> previouslyCachedImage<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
</span><span class="code-line">    contentType<span class="token punctuation">,</span>
</span><span class="code-line">    maxAge<span class="token operator">:</span> opts<span class="token operator">?.</span>previousCacheEntry<span class="token operator">?.</span>cacheControl<span class="token operator">?.</span>revalidate <span class="token operator">||</span> maxAge<span class="token punctuation">,</span>
</span><span class="code-line">    etag<span class="token operator">:</span> previouslyCachedImage<span class="token punctuation">.</span>etag<span class="token punctuation">,</span>
</span><span class="code-line">    upstreamEtag<span class="token operator">:</span> previouslyCachedImage<span class="token punctuation">.</span>upstreamEtag<span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>전에 Cache가 됐던 이미지는 리턴처리한다.</li>
</ul>
<pre class="language-tsx"><code class="language-tsx code-highlight"><span class="code-line"> <span class="token comment">// https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L790-L841</span>
</span><span class="code-line"> <span class="token keyword">try</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">let</span> optimizedBuffer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">optimizeImage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">      buffer<span class="token operator">:</span> upstreamBuffer<span class="token punctuation">,</span>
</span><span class="code-line">      contentType<span class="token punctuation">,</span>
</span><span class="code-line">      quality<span class="token punctuation">,</span>
</span><span class="code-line">      width<span class="token punctuation">,</span>
</span><span class="code-line">      concurrency<span class="token operator">:</span> nextConfig<span class="token punctuation">.</span><span class="token property-access">experimental</span><span class="token punctuation">.</span><span class="token property-access">imgOptConcurrency</span><span class="token punctuation">,</span>
</span><span class="code-line">      limitInputPixels<span class="token operator">:</span> nextConfig<span class="token punctuation">.</span><span class="token property-access">experimental</span><span class="token punctuation">.</span><span class="token property-access">imgOptMaxInputPixels</span><span class="token punctuation">,</span>
</span><span class="code-line">      sequentialRead<span class="token operator">:</span> nextConfig<span class="token punctuation">.</span><span class="token property-access">experimental</span><span class="token punctuation">.</span><span class="token property-access">imgOptSequentialRead</span><span class="token punctuation">,</span>
</span><span class="code-line">      timeoutInSeconds<span class="token operator">:</span> nextConfig<span class="token punctuation">.</span><span class="token property-access">experimental</span><span class="token punctuation">.</span><span class="token property-access">imgOptTimeoutInSeconds</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token spread operator">...</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>optimizeImage를 통해 buffer를 받게된다 - 실험적 config도 보인다.<!-- -->
<table><thead><tr><th>옵션명</th><th>기능 요약</th></tr></thead><tbody><tr><td><code>concurrency</code></td><td>이미지 동시 처리 개수 제한 (성능 관련)</td></tr><tr><td><code>limitInputPixels</code></td><td>이미지 크기 제한 (보안/안정성)</td></tr><tr><td><code>sequentialRead</code></td><td>순차 읽기 여부 설정 (I/O 호환성)</td></tr><tr><td><code>timeoutInSeconds</code></td><td>이미지 최적화 타임아웃 설정 (무한대기 방지)</td></tr><tr><td>같은 기능을 지원할 수도 있다.</td><td></td></tr></tbody></table>
</li>
</ul>
<h3 id="optimizeimage">optimizeImage</h3>
<ul>
<li>이미지 최적화 함수</li>
</ul>
<pre class="language-ts"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L535-L590</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">optimizeImage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">  buffer<span class="token punctuation">,</span>
</span><span class="code-line">  contentType<span class="token punctuation">,</span>
</span><span class="code-line">  quality<span class="token punctuation">,</span>
</span><span class="code-line">  width<span class="token punctuation">,</span>
</span><span class="code-line">  height<span class="token punctuation">,</span>
</span><span class="code-line">  concurrency<span class="token punctuation">,</span>
</span><span class="code-line">  limitInputPixels<span class="token punctuation">,</span>
</span><span class="code-line">  sequentialRead<span class="token punctuation">,</span>
</span><span class="code-line">  timeoutInSeconds<span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">  buffer<span class="token operator">:</span> Buffer<span class="token punctuation">;</span>
</span><span class="code-line">  contentType<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">  quality<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">  width<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">  height<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">  concurrency<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</span><span class="code-line">  limitInputPixels<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">  sequentialRead<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</span><span class="code-line">  timeoutInSeconds<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Buffer<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">const</span> sharp <span class="token operator">=</span> <span class="token function">getSharp</span><span class="token punctuation">(</span>concurrency<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//nextConfig.experimental.imgOptConcurrency</span>
</span><span class="code-line">  <span class="token keyword">const</span> transformer <span class="token operator">=</span> <span class="token function">sharp</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token punctuation">{</span>
</span><span class="code-line">    limitInputPixels<span class="token punctuation">,</span> <span class="token comment">// nextConfig.experimental.imgOptMaxInputPixels</span>
</span><span class="code-line">    sequentialRead<span class="token operator">:</span> sequentialRead <span class="token operator">??</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token comment">// nextConfig.experimental.imgOptSequentialRead</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">      seconds<span class="token operator">:</span> timeoutInSeconds <span class="token operator">??</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token comment">// nextConfig.experimental.imgOptTimeoutInSeconds</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    transformer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
</span><span class="code-line">    transformer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
</span><span class="code-line">      withoutEnlargement<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>contentType <span class="token operator">===</span> <span class="token constant">AVIF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    transformer<span class="token punctuation">.</span><span class="token function">avif</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">      quality<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>quality <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">      effort<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>contentType <span class="token operator">===</span> <span class="token constant">WEBP</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    transformer<span class="token punctuation">.</span><span class="token function">webp</span><span class="token punctuation">(</span><span class="token punctuation">{</span> quality <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>contentType <span class="token operator">===</span> <span class="token constant">PNG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    transformer<span class="token punctuation">.</span><span class="token function">png</span><span class="token punctuation">(</span><span class="token punctuation">{</span> quality <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>contentType <span class="token operator">===</span> <span class="token constant">JPEG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    transformer<span class="token punctuation">.</span><span class="token function">jpeg</span><span class="token punctuation">(</span><span class="token punctuation">{</span> quality<span class="token punctuation">,</span> mozjpeg<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">const</span> optimizedBuffer <span class="token operator">=</span> <span class="token keyword">await</span> transformer<span class="token punctuation">.</span><span class="token function">toBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">return</span> optimizedBuffer<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>여기서 sharp가 등장한다. <code>getSharp</code>로 sharp가 있는지 없는지 검사한 후 sharp 라이브러리로 최적화한다.</li>
<li>sharp 라이브러리에서 지원하는 기능이라면 next도 실험적(canary)으로 검토 후 기능을 추가하는 것 같다.</li>
</ul>
<h3 id="imageoptimizer">imageOptimizer</h3>
<p>next/src/server/next-server.ts</p>
<pre class="language-ts"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// &lt;https://github.com/vercel/next.js/blob/canary/packages/next/src/server/next-server.ts#L750-L802&gt;</span>
</span><span class="code-line"><span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token function">imageOptimizer</span><span class="token punctuation">(</span>
</span><span class="code-line">    req<span class="token operator">:</span> NodeNextRequest<span class="token punctuation">,</span>
</span><span class="code-line">    res<span class="token operator">:</span> NodeNextResponse<span class="token punctuation">,</span>
</span><span class="code-line">    paramsResult<span class="token operator">:</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#x27;./image-optimizer&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ImageParamsResult<span class="token punctuation">,</span>
</span><span class="code-line">    previousCacheEntry<span class="token operator">?</span><span class="token operator">:</span> IncrementalResponseCacheEntry <span class="token operator">|</span> <span class="token keyword">null</span>
</span><span class="code-line">  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token punctuation">{</span>
</span><span class="code-line">    buffer<span class="token operator">:</span> Buffer
</span><span class="code-line">    contentType<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line">    maxAge<span class="token operator">:</span> <span class="token builtin">number</span>
</span><span class="code-line">    upstreamEtag<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line">    etag<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token comment">// mimimal환경에선 지원 x</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NEXT_MINIMAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
</span><span class="code-line">        <span class="token string">&#x27;invariant: imageOptimizer should not be called in minimal mode&#x27;</span>
</span><span class="code-line">      <span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
</span><span class="code-line">		<span class="token comment">// 동적으로 `image-optimizer` 모듈을 가져옴(최소 실행 환경 대비 최적화)</span>
</span><span class="code-line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> imageOptimizer<span class="token punctuation">,</span> fetchExternalImage<span class="token punctuation">,</span> fetchInternalImage <span class="token punctuation">}</span> <span class="token operator">=</span>
</span><span class="code-line">        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./image-optimizer&#x27;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#x27;./image-optimizer&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">				<span class="token comment">// 내부 이미지일때 컨트롤할 req handler</span>
</span><span class="code-line">      <span class="token keyword">const</span> <span class="token function-variable function">handleInternalReq</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
</span><span class="code-line">        newReq<span class="token operator">:</span> IncomingMessage<span class="token punctuation">,</span>
</span><span class="code-line">        newRes<span class="token operator">:</span> ServerResponse
</span><span class="code-line">      <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newReq<span class="token punctuation">.</span>url <span class="token operator">===</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invariant attempted to optimize _next/image itself</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>routerServerHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invariant missing routerServerHandler</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">routerServerHandler</span><span class="token punctuation">(</span>newReq<span class="token punctuation">,</span> newRes<span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token keyword">return</span>
</span><span class="code-line">      <span class="token punctuation">}</span>
</span><span class="code-line">			<span class="token comment">// image url이 절대경로인지, 최종 이미지 URL</span>
</span><span class="code-line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> isAbsolute<span class="token punctuation">,</span> href <span class="token punctuation">}</span> <span class="token operator">=</span> paramsResult
</span><span class="code-line">
</span><span class="code-line">			<span class="token comment">// 외부 이미지 URL이면 fetchExternalImage(href), 내부라면 fetchInternalImage</span>
</span><span class="code-line">      <span class="token keyword">const</span> imageUpstream <span class="token operator">=</span> isAbsolute
</span><span class="code-line">
</span><span class="code-line">        <span class="token operator">?</span> <span class="token keyword">await</span> <span class="token function">fetchExternalImage</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token comment">// 내부 이미지라 mock 이미지를 보내는걸로? 잘 모르겠슴</span>
</span><span class="code-line">        <span class="token operator">:</span> <span class="token keyword">await</span> <span class="token function">fetchInternalImage</span><span class="token punctuation">(</span>
</span><span class="code-line">            href<span class="token punctuation">,</span>
</span><span class="code-line">            req<span class="token punctuation">.</span>originalRequest<span class="token punctuation">,</span>
</span><span class="code-line">            res<span class="token punctuation">.</span>originalResponse<span class="token punctuation">,</span>
</span><span class="code-line">            handleInternalReq
</span><span class="code-line">          <span class="token punctuation">)</span>
</span><span class="code-line">		<span class="token comment">// 이미지 최적화 로직 수행</span>
</span><span class="code-line">      <span class="token keyword">return</span> <span class="token function">imageOptimizer</span><span class="token punctuation">(</span>imageUpstream<span class="token punctuation">,</span> paramsResult<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
</span><span class="code-line">        isDev<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderOpts<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
</span><span class="code-line">        previousCacheEntry<span class="token punctuation">,</span>
</span><span class="code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span></code></pre>
<h2 id="2-캐싱">2. 캐싱</h2>
<pre class="language-ts"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">writeToCacheDir</span><span class="token punctuation">(</span>
</span><span class="code-line">  dir<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
</span><span class="code-line">  extension<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
</span><span class="code-line">  maxAge<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
</span><span class="code-line">  expireAt<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
</span><span class="code-line">  buffer<span class="token operator">:</span> Buffer<span class="token punctuation">,</span>
</span><span class="code-line">  etag<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
</span><span class="code-line">  upstreamEtag<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line"><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>
</span><span class="code-line">    dir<span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>maxAge<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expireAt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>etag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>upstreamEtag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extension<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
</span><span class="code-line">  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">await</span> promises<span class="token punctuation">.</span><span class="token function">rm</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> force<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">await</span> promises<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">await</span> promises<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>이런식으로 캐시 디렉토리에 저장한다.
/next/src/server/image-optimizer.ts | function handleNextImageRequest</li>
</ul>
<pre class="language-ts"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// 이미지 최적화 캐시 인스턴스 생성(이때 경로가 캐시 경로가 생성된다)</span>
</span><span class="code-line"><span class="token keyword">const</span> imageOptimizerCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageOptimizerCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">  distDir<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>distDir<span class="token punctuation">,</span>
</span><span class="code-line">  nextConfig<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextConfig<span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<ul>
<li>이런식으로 ImageOptimizerCache가 있는데, 이 클래스에서 새로운 인스턴스를 만들게되면,</li>
</ul>
<p>/next/src/server/image-optimizer.ts | class ImageOptimizerCache</p>
<pre class="language-ts"><code class="language-ts code-highlight"><span class="code-line"> <span class="token keyword">async</span> <span class="token function">set</span><span class="token punctuation">(</span>
</span><span class="code-line">    cacheKey<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
</span><span class="code-line">    value<span class="token operator">:</span> IncrementalCacheValue <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      cacheControl<span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">      cacheControl<span class="token operator">?</span><span class="token operator">:</span> CacheControl
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>nextConfig<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>isrFlushToDisk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token keyword">return</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token operator">?.</span>kind <span class="token operator">!==</span> CachedRouteKind<span class="token punctuation">.</span><span class="token constant">IMAGE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;invariant attempted to set non-image to image-cache&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">const</span> revalidate <span class="token operator">=</span> cacheControl<span class="token operator">?.</span>revalidate
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> revalidate <span class="token operator">!==</span> <span class="token string">&#x27;number&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvariantError</span><span class="token punctuation">(</span><span class="token string">&#x27;revalidate must be a number for image-cache&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">const</span> expireAt <span class="token operator">=</span>
</span><span class="code-line">      Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>revalidate<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextConfig<span class="token punctuation">.</span>images<span class="token punctuation">.</span>minimumCacheTTL<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">+</span>
</span><span class="code-line">      Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">try</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token keyword">await</span> <span class="token function">writeToCacheDir</span><span class="token punctuation">(</span>
</span><span class="code-line">        <span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheDir<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">        value<span class="token punctuation">.</span>extension<span class="token punctuation">,</span>
</span><span class="code-line">        revalidate<span class="token punctuation">,</span>
</span><span class="code-line">        expireAt<span class="token punctuation">,</span>
</span><span class="code-line">        value<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
</span><span class="code-line">        value<span class="token punctuation">.</span>etag<span class="token punctuation">,</span>
</span><span class="code-line">        value<span class="token punctuation">.</span>upstreamEtag
</span><span class="code-line">      <span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">      Log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to write image to cache </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cacheKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>이 set 함수가 실행되어, 지정된 디렉토리 내에 캐시된 이미지가 최적화된 이미지가 저장된다.</li>
</ul></div><hr class="my-10"/><section></section></div><!--/$--></article></main><div class="w-full h-32"><footer class="footer footer-center p-10 justify-center"><nav><div class="grid grid-flow-col gap-7"><a title="github" target="_blank" href="https://github.com/gogleset"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a><a title="email" target="_blank" href="mailto:choij2494@gmail.com"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 75.294 75.294" class="fill-current"><path d="M66.097,12.089h-56.9C4.126,12.089,0,16.215,0,21.286v32.722c0,5.071,4.126,9.197,9.197,9.197h56.9   c5.071,0,9.197-4.126,9.197-9.197V21.287C75.295,16.215,71.169,12.089,66.097,12.089z M61.603,18.089L37.647,33.523L13.691,18.089   H61.603z M66.097,57.206h-56.9C7.434,57.206,6,55.771,6,54.009V21.457l29.796,19.16c0.04,0.025,0.083,0.042,0.124,0.065   c0.043,0.024,0.087,0.047,0.131,0.069c0.231,0.119,0.469,0.215,0.712,0.278c0.025,0.007,0.05,0.01,0.075,0.016   c0.267,0.063,0.537,0.102,0.807,0.102c0.001,0,0.002,0,0.002,0c0.002,0,0.003,0,0.004,0c0.27,0,0.54-0.038,0.807-0.102   c0.025-0.006,0.05-0.009,0.075-0.016c0.243-0.063,0.48-0.159,0.712-0.278c0.044-0.022,0.088-0.045,0.131-0.069   c0.041-0.023,0.084-0.04,0.124-0.065l29.796-19.16v32.551C69.295,55.771,67.86,57.206,66.097,57.206z"></path></svg></a></div></nav></footer></div><script src="https://gogleset.github.io/_next/static/chunks/webpack-14f60f031ad37603.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"https://gogleset.github.io/_next/static/css/cc4162795b3fa97e.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"2:I[5751,[],\"\"]\n5:I[9275,[],\"\"]\n7:I[2864,[\"231\",\"static/chunks/231-e841b6edcc38d627.js\",\"613\",\"static/chunks/app/posts/%5Bid%5D/error-43f6426e3a7526c8.js\"],\"default\"]\n8:I[1343,[],\"\"]\n9:I[8496,[\"231\",\"static/chunks/231-e841b6edcc38d627.js\",\"185\",\"static/chunks/app/layout-c5dcdd748a4b65d7.js\"],\"default\"]\na:I[231,[\"231\",\"static/chunks/231-e841b6edcc38d627.js\",\"185\",\"static/chunks/app/layout-c5dcdd748a4b65d7.js\"],\"\"]\nb:I[6372,[\"231\",\"static/chunks/231-e841b6edcc38d627.js\",\"185\",\"static/chunks/app/layout-c5dcdd748a4b65d7.js\"],\"default\"]\nc:I[1842,[\"231\",\"static/chunks/231-e841b6edcc38d627.js\",\"185\",\"static/chunks/app/layout-c5dcdd748a4b65d7.js\"],\"default\"]\nd:I[6372,[\"231\",\"static/chunks/231-e841b6edcc38d627.js\",\"185\",\"static/chunks/app/layout-c5dcdd748a4b65d7.js\"],\"myDrawer3Close\"]\ne:I[1301,[\"231\",\"static/chunks/231-e841b6edcc38d627.js\",\"185\",\"static/chunks/app/layout-c5dcdd748a4b65d7.js\"],\"default\"]\nf:I[4404,[\"231\",\"static/chunks/231-e841b6edcc38d627.js\",\"185\",\"static/chunks/app/layout-c5dcdd748a4b65d7.js\"],\"GoogleAnalytics\"]\n11:I[6314,[\"231\",\"static/chunks/231-e841b6edcc38d627.js\",\"470\",\"static/chunks/app/global-error-9622828abc1b57c8.js\"],\"default\"]\n6:[\"id\",\"NextImage\",\"d\"]\n12:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"https://gogleset.github.io/_next/static/css/cc4162795b3fa97e.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L2\",null,{\"buildId\":\"K6m82OSwdlJ0uSp9oORRs\",\"assetPrefix\":\"https://gogleset.github.io\",\"initialCanonicalUrl\":\"/posts/NextImage\",\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"id\",\"NextImage\",\"d\"],{\"children\":[\"__PAGE__?{\\\"id\\\":\\\"NextImage\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"id\",\"NextImage\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L3\",\"$L4\"],null],null]},[[\"$\",\"div\",null,{\"className\":\"flex flex-col w-full\",\"children\":[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",\"$6\",\"children\"],\"error\":\"$7\",\"errorStyles\":[],\"errorScripts\":[],\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]}],null],null]},[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"html\",null,{\"lang\":\"ko\",\"data-theme\":\"cupcake\",\"children\":[[\"$\",\"body\",null,{\"children\":[\"$\",\"$L9\",null,{\"children\":[[\"$\",\"header\",null,{\"className\":\" border-gray-200 px-4 lg:px-6 py-3.5  max-h-[68px] w-full sticky top-0 bg-base-100\",\"children\":[\"$\",\"div\",null,{\"className\":\"w-full max-w-[1140px] mx-auto\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex flex-wrap justify-between items-center \",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex gap-3 items-center\",\"children\":[[\"$\",\"$La\",null,{\"href\":\"/\",\"className\":\"self-center text-xl font-semibold whitespace-nowrap cursor-pointer\",\"children\":\"gogleset's note\"}],[\"$\",\"div\",null,{\"className\":\"divider divider-horizontal w-2 max-lg:hidden\"}],[\"$\",\"nav\",null,{\"className\":\"max-lg:hidden\",\"children\":[\"$\",\"$Lb\",null,{}]}]]}],[\"$\",\"div\",null,{\"className\":\"flex gap-4 items-center justify-center\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex max-lg:hidden\",\"children\":[\"$\",\"$Lc\",null,{}]}],[\"$\",\"div\",null,{\"className\":\"drawer drawer-end lg:hidden\",\"children\":[[\"$\",\"input\",null,{\"id\":\"my-drawer-3\",\"type\":\"checkbox\",\"className\":\"drawer-toggle\"}],[\"$\",\"div\",null,{\"className\":\"drawer-content flex flex-col\",\"children\":[\"$\",\"div\",null,{\"className\":\" w-full p-0\",\"children\":[\"$\",\"div\",null,{\"className\":\"lg:hidden\",\"children\":[\"$\",\"label\",null,{\"htmlFor\":\"my-drawer-3\",\"aria-label\":\"open sidebar\",\"className\":\"cursor-pointer\",\"children\":[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"fill\":\"none\",\"viewBox\":\"0 0 24 24\",\"className\":\"inline-block w-8 h-8 stroke-current\",\"children\":[\"$\",\"path\",null,{\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"strokeWidth\":\"2\",\"d\":\"M4 6h16M4 12h16M4 18h16\"}]}]}]}]}]}],[\"$\",\"div\",null,{\"className\":\"drawer-side\",\"children\":[[\"$\",\"label\",null,{\"htmlFor\":\"my-drawer-3\",\"aria-label\":\"close sidebar\",\"className\":\"drawer-overlay\"}],[\"$\",\"div\",null,{\"className\":\"menu p-4 w-80 min-h-full bg-base-200 justify-between\",\"children\":[[\"$\",\"$Lb\",null,{\"col\":true}],[\"$\",\"div\",null,{\"className\":\"flex justify-between\",\"children\":[[\"$\",\"svg\",null,{\"onClick\":\"$d\",\"className\":\"fill-current cursor-pointer\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"width\":\"40\",\"height\":\"40\",\"viewBox\":\"0 0 512 512\",\"children\":[\"$\",\"polygon\",null,{\"points\":\"400 145.49 366.51 112 256 222.51 145.49 112 112 145.49 222.51 256 112 366.51 145.49 400 256 289.49 366.51 400 400 366.51 289.49 256 400 145.49\"}]}],[\"$\",\"$Lc\",null,{}]]}]]}]]}]]}]]}]]}],[\"$\",\"$Le\",null,{}]]}]}],[\"$\",\"main\",null,{\"className\":\"flex w-full justify-center items-center flex-col\",\"children\":[\"$\",\"article\",null,{\"className\":\"flex justify-center w-full max-w-[1080px] p-5\",\"children\":[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"section\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"container flex pt-32 min-h-screen  mx-auto\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center max-w-sm mx-auto text-center\",\"children\":[[\"$\",\"p\",null,{\"className\":\"p-3 text-sm font-medium text-current rounded-full  \",\"children\":[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"fill\":\"none\",\"viewBox\":\"0 0 24 24\",\"strokeWidth\":\"2\",\"stroke\":\"currentColor\",\"className\":\"w-6 h-6\",\"children\":[\"$\",\"path\",null,{\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"d\":\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\"}]}]}],[\"$\",\"p\",null,{\"className\":\"mt-3 text-2xl font-semibold md:text-3xl\",\"children\":\"OOPS! \"}],[\"$\",\"h1\",null,{\"className\":\"mt-1 text-xl font-semibold\",\"children\":\"404 page not found\"}],[\"$\",\"$La\",null,{\"href\":\"/\",\"className\":\"mt-10 btn btn-success\",\"children\":\"Home\"}]]}]}]}],\"notFoundStyles\":[],\"styles\":null}]}]}],[\"$\",\"div\",null,{\"className\":\"w-full h-32\",\"children\":[\"$\",\"footer\",null,{\"className\":\"footer footer-center p-10 justify-center\",\"children\":[\"$\",\"nav\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"grid grid-flow-col gap-7\",\"children\":[[\"$\",\"a\",null,{\"title\":\"github\",\"target\":\"_blank\",\"href\":\"https://github.com/gogleset\",\"children\":[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"width\":\"24\",\"height\":\"24\",\"viewBox\":\"0 0 24 24\",\"className\":\"fill-current\",\"children\":[\"$\",\"path\",null,{\"d\":\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"}]}]}],[\"$\",\"a\",null,{\"title\":\"email\",\"target\":\"_blank\",\"href\":\"mailto:choij2494@gmail.com\",\"children\":[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"width\":\"24\",\"height\":\"24\",\"viewBox\":\"0 0 75.294 75.294\",\"className\":\"fill-current\",\"children\":[\"$\",\"path\",null,{\"d\":\"M66.097,12.089h-56.9C4.126,12.089,0,16.215,0,21.286v32.722c0,5.071,4.126,9.197,9.197,9.197h56.9   c5.071,0,9.197-4.126,9.197-9.197V21.287C75.295,16.215,71.169,12.089,66.097,12.089z M61.603,18.089L37.647,33.523L13.691,18.089   H61.603z M66.097,57.206h-56.9C7.434,57.206,6,55.771,6,54.009V21.457l29.796,19.16c0.04,0.025,0.083,0.042,0.124,0.065   c0.043,0.024,0.087,0.047,0.131,0.069c0.231,0.119,0.469,0.215,0.712,0.278c0.025,0.007,0.05,0.01,0.075,0.016   c0.267,0.063,0.537,0.102,0.807,0.102c0.001,0,0.002,0,0.002,0c0.002,0,0.003,0,0.004,0c0.27,0,0.54-0.038,0.807-0.102   c0.025-0.006,0.05-0.009,0.075-0.016c0.243-0.063,0.48-0.159,0.712-0.278c0.044-0.022,0.088-0.045,0.131-0.069   c0.041-0.023,0.084-0.04,0.124-0.065l29.796-19.16v32.551C69.295,55.771,67.86,57.206,66.097,57.206z\"}]}]}]]}]}]}]}]]}]}],[\"$\",\"$Lf\",null,{\"gaId\":\"$undefined\"}]]}],null],[[\"$\",\"div\",null,{\"className\":\"flex pt-1 min-h-screen\",\"children\":[\"$\",\"div\",null,{\"className\":\"loading loading-infinity loading-lg \"}]}],[],[]]],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$L10\"],\"globalErrorComponent\":\"$11\",\"missingSlots\":\"$W12\"}]]\n"])</script><script>self.__next_f.push([1,"13:I[3556,[\"173\",\"static/chunks/173-085cf89c21a1457b.js\",\"722\",\"static/chunks/app/posts/%5Bid%5D/page-ed3992e816e0c12e.js\"],\"default\"]\n"])</script><script>self.__next_f.push([1,"4:[[[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center justify-center h-64 gap-3\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-3xl max-lg:text-2xl font-bold text-center\",\"children\":\"Next.js Image 어떻게 최적화 할까?\"}],[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center justify-center gap-1\",\"children\":[[\"$\",\"span\",null,{\"className\":\"text-gray\",\"children\":\"2025-04-20\"}],[\"$\",\"div\",null,{\"className\":\"flex gap-1 \",\"children\":[[\"$\",\"span\",\"Next_0\",{\"className\":\"badge badge-accent\",\"children\":\"Next\"}],[\"$\",\"span\",\"Image_1\",{\"className\":\"badge badge-accent\",\"children\":\"Image\"}]]}]]}]]}],[\"$\",\"hr\",null,{\"className\":\"mb-[0px]\"}]],[\"$\",\"div\",null,{\"className\":\"flex flex-col prose max-w-full max-sm:prose-sm \",\"children\":[[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"2025.4 Next.js canary ver\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"toc\",\"children\":\"toc\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#%EC%84%A0%ED%98%95%EC%A0%81%EC%9C%BC%EB%A1%9C-%EB%82%98%ED%83%80%EB%82%B8-nextjs-image-%ED%98%B8%EC%B6%9C\",\"children\":\"선형적으로 나타낸 Next.js Image 호출\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#request%EC%9D%98-%EC%B2%98%EB%A6%AC\",\"children\":\"Request의 처리\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"#%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%B5%9C%EC%A0%81%ED%99%94-%ED%95%A0%EA%B9%8C\",\"children\":\"어떻게 최적화 할까?\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"#1-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%B5%9C%EC%A0%81%ED%99%94%EC%9A%A9%EB%9F%89-%EC%A4%84%EC%9D%B4%EA%B8%B0\",\"children\":\"1. 이미지 최적화(용량 줄이기)\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#optimizeimage\",\"children\":\"optimizeImage\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#imageoptimizer\",\"children\":\"imageOptimizer\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#2-%EC%BA%90%EC%8B%B1\",\"children\":\"2. 캐싱\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"선형적으로-나타낸-nextjs-image-호출\",\"children\":\"선형적으로 나타낸 Next.js Image 호출\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"사용자 브라우저가 \",[\"$\",\"code\",null,{\"children\":\"/_next/image/...\"}],\" 경로로 이미지 요청을 보냄\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Next.js 서버에서 해당 요청이 \",[\"$\",\"code\",null,{\"children\":\"handleNextImageRequest\"}],\" 핸들러로 라우팅\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"이 핸들러는 요청이 \",[\"$\",\"code\",null,{\"children\":\"/_next/image\"}],\"로 시작하는지 확인하고, 유효한 이미지 요청인지 파라미터를 검증\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"이미지 캐시를 확인하여 이미 최적화된 이미지가 있는지 확인\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"캐시에 없다면 \",[\"$\",\"code\",null,{\"children\":\"imageOptimizer\"}],\" 메서드를 통해 이미지를 실제로 최적화\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"최적화된 이미지를 응답으로 반환하고 캐시에 저장\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"request의-처리\",\"children\":\"Request의 처리\"}],\"\\n\",[\"$\",\"pre\",null,{\"className\":\"language-ts\",\"children\":[\"$\",\"code\",null,{\"className\":\"language-ts code-highlight\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L711-L760\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"protected\"}],\" handleNextImageRequest\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function-variable function\",\"children\":\"NodeRouteHandler\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    req\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    res\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"    parsedUrl\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\u003e\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// URL 경로가 없거나 '/_next/image'로 시작하지 않으면 이 핸들러에서 처리하지 않음\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!\"}],\"parsedUrl\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"pathname \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"||\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!\"}],\"parsedUrl\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"pathname\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"startsWith\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'/_next/image'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"false\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 미들웨어 요청이면 처리하지 않음\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"getRequestMeta\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"req\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'middlewareInvoke'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"false\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 최소 모드이거나 정적 내보내기 모드일 경우 이미지 최적화를 처리하지 않고 400 오류 반환\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"minimalMode \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"||\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"output \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"===\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'export'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"||\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      process\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"env\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"NEXT_MINIMAL\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      res\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"statusCode \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"400\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      res\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"body\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'Bad Request'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"send\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"true\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"else\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 이미지 최적화 캐시 모듈 불러오기\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" ImageOptimizerCache \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"require\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'./image-optimizer'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"as\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"typeof\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"import\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'./image-optimizer'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 이미지 최적화 캐시 인스턴스 생성(이때 경로가 캐시 경로가 생성된다)\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" imageOptimizerCache \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"ImageOptimizerCache\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        distDir\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"distDir\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        nextConfig\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 이미지 응답 처리 유틸리티 불러오기\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" sendResponse\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" ImageError \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"require\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'./image-optimizer'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"as\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"typeof\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"import\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'./image-optimizer'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 이미지 응답 캐시가 초기화되지 않았으면 오류 발생(확실치 않음)\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!\"}],[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"imageResponseCache\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"throw\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"Error\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'invariant image optimizer cache was not initialized'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" imagesConfig \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"images\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 기본 로더가 아니거나 최적화를 사용하지 않도록 설정된 경우 404 반환\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"imagesConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"loader \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!==\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'default'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"||\"}],\" imagesConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"unoptimized\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"render404\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"req\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" res\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"true\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 요청 파라미터 유효성 검사\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" paramsResult \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" ImageOptimizerCache\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"validateParams\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        req\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"originalRequest\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        parsedUrl\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"query\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!\"}],[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"renderOpts\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"dev\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 파라미터가 유효하지 않으면 400 오류 반환\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'errorMessage'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"in\"}],\" paramsResult\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        res\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"statusCode \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"400\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        res\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"body\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"paramsResult\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"errorMessage\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"send\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"true\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 캐시 키 생성\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" cacheKey \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" ImageOptimizerCache\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"getCacheKey\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"paramsResult\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"try\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 파일 확장자 추출 유틸리티 불러오기\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" getExtension \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"require\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'./serve-static'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"as\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"typeof\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"import\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'./serve-static'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 이미지 응답 캐시에서 결과 가져오기, 없으면 생성\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" cacheEntry \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"imageResponseCache\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"get\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          cacheKey\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// responseGenerator\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" previousCacheEntry \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\u003e\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 이미지 최적화 실행\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" buffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" contentType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" maxAge\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" upstreamEtag\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" etag \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"\\t            \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 없다면 실행해서 _next/image로 이미지 캐싱\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"              \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"imageOptimizer\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"                req\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"                res\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"                paramsResult\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"                previousCacheEntry\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"              \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 캐시 엔트리 반환\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"              value\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"                kind\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" CachedRouteKind\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"IMAGE\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"                buffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"                etag\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"                extension\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"getExtension\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"contentType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"as\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"string\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"                upstreamEtag\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"              \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"              isFallback\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"false\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"              cacheControl\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" revalidate\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" maxAge\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" expire\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"undefined\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            routeKind\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" RouteKind\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"IMAGE\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            incrementalCache\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" imageOptimizerCache\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            isFallback\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"false\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 캐시 결과가 이미지 종류가 아니면 오류 발생\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"cacheEntry\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?.\"}],\"value\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?.\"}],\"kind \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!==\"}],\" CachedRouteKind\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"IMAGE\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"throw\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"Error\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'invariant did not get entry from image response cache'\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 응답 전송\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"sendResponse\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          req\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"originalRequest\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          res\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"originalResponse\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          paramsResult\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"href\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          cacheEntry\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"value\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"extension\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          cacheEntry\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"value\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"buffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          cacheEntry\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"value\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"etag\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          paramsResult\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"isStatic\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          cacheEntry\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"isMiss \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'MISS'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" cacheEntry\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"isStale \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'STALE'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'HIT'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 캐시 상태 표시\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          imagesConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          cacheEntry\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"cacheControl\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?.\"}],\"revalidate \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"||\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"0\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"Boolean\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"renderOpts\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"dev\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"true\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"catch\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"err\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 이미지 관련 오류인 경우 해당 상태 코드와 메시지 반환\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"err \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"instanceof\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"ImageError\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          res\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"statusCode \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" err\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"statusCode\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          res\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"body\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"err\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"message\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"send\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"true\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 그 외 오류는 상위로 전파\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"throw\"}],\" err\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}]]}]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"이미지 저장과 최적화가 이루어지고 있는 함수이다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"맨 처음 Request를 받으면 실행되는 로직이다.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"어떻게-최적화-할까\",\"children\":\"어떻게 최적화 할까?\"}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"1-이미지-최적화용량-줄이기\",\"children\":\"1. 이미지 최적화(용량 줄이기)\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"/next/src/server/image-optimizer.ts\"}],\"\\n\",[\"$\",\"pre\",null,{\"className\":\"language-ts\",\"children\":[\"$\",\"code\",null,{\"className\":\"language-ts code-highlight\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"AVIF\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/avif\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"WEBP\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/webp\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"PNG\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/png\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"JPEG\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/jpeg\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"GIF\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/gif\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"SVG\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/svg+xml\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"ICO\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/x-icon\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"ICNS\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/x-icns\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"TIFF\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/tiff\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"BMP\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/bmp\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"ANIMATABLE_TYPES\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"[\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"WEBP\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"PNG\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"GIF\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"]\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 움직일만한 타입(PNG는 APNG라는 포맷이 있다.)\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"BYPASS_TYPES\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"[\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"SVG\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"ICO\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"ICNS\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"BMP\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"]\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 최적화 안해주는 타입들\"}],\"\\n\"]}]]}]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"Next.js가 관리하고 있는 image 속성값들이다.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"pre\",null,{\"className\":\"language-ts\",\"children\":[\"$\",\"code\",null,{\"className\":\"language-ts code-highlight\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L711-L760\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// buffer에서 뽑은 contentType이나, imageUpstream이라는 Props로 받은 타입\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"upstreamType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 요청된 이미지가 SVG 형식이고, 설정에서 SVG 허용이 비활성화되어 있다면 에러 처리\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    upstreamType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"startsWith\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/svg\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"\u0026\u0026\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!\"}],\"nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"images\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"dangerouslyAllowSVG\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    Log\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"error\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token template-string\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"The requested resource \\\"\"}],[\"$\",\"span\",null,{\"className\":\"token interpolation\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"$${\"}],\"href\",[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"}\"}]]}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\" has type \\\"\"}],[\"$\",\"span\",null,{\"className\":\"token interpolation\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"$${\"}],\"upstreamType\",[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"}\"}]]}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\" but dangerouslyAllowSVG is disabled\"}],[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}]]}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"throw\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"ImageError\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"400\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'\\\"url\\\" parameter is valid but image type is not allowed'\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 요청된 이미지가 애니메이션 가능한 타입이며 실제로 애니메이션 이미지라면, 최적화하지 않고 원본 반환\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"ANIMATABLE_TYPES\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"includes\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"upstreamType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"\u0026\u0026\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"isAnimated\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"upstreamBuffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    Log\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"warnOnce\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token template-string\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"The requested resource \\\"\"}],[\"$\",\"span\",null,{\"className\":\"token interpolation\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"$${\"}],\"href\",[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"}\"}]]}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\" is an animated image so it will not be optimized. Consider adding the \\\"unoptimized\\\" property to the \u003cImage\u003e.\"}],[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}]]}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" buffer\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" upstreamBuffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" contentType\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" upstreamType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" maxAge \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 벡터 이미지일 경우 (ex. image/svg+xml), 원본 반환\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"VECTOR_TYPES\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"includes\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"upstreamType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 이 경우에는 이미 dangerouslyAllowSVG를 통해 허용된 상태이므로 별도 경고 없이 반환\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" buffer\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" upstreamBuffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" contentType\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" upstreamType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" maxAge \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// BYPASS_TYPES에 등록되어 있는경우\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"BYPASS_TYPES\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"includes\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"upstreamType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      buffer\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" upstreamBuffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      contentType\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" upstreamType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      maxAge\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      etag\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" upstreamEtag\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      upstreamEtag\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 이미지 형식이 아니거나 잘못된 형식일 경우 에러 처리\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!\"}],\"upstreamType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"startsWith\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"image/\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"||\"}],\" upstreamType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"includes\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\",\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    Log\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"error\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"The requested resource isn't a valid image for\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      href\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"received\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"      upstreamType\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"throw\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"ImageError\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"400\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"\\\"The requested resource isn't a valid image.\\\"\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}]]}]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"svg, dangerouslyAllowSVG option을 썼을때, WEBP, PNG, GIF,애니메이션이 들어갔다면 최적화를 하지 않는다. BYPASS_TYPES에 등록되어 있는경우와 그 이외에 unoptimized 옵션을 썼을때도 마찬가지다.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"그 다음 로직이다.\"}],\"\\n\",[\"$\",\"pre\",null,{\"className\":\"language-ts\",\"children\":[\"$\",\"code\",null,{\"className\":\"language-ts code-highlight\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"//  https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L762-L775\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"let\"}],\" contentType\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"string\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"mimeType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    contentType \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" mimeType\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"else\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    upstreamType\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?.\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"startsWith\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'image/'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"\u0026\u0026\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"getExtension\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"upstreamType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"\u0026\u0026\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// =\u003e 'jpeg', 'webp', 'avif'\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    upstreamType \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!==\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"WEBP\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"\u0026\u0026\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 'image/webp'\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    upstreamType \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!==\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"AVIF\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 'image/avif'\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    contentType \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" upstreamType \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 원본 이미지의 buffer에서 추출한 값이나 이미지 메타정보의 contentType\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"else\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    contentType \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"JPEG\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}]]}]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"contentType을 결정하는데\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"mimeType이 있다면 contentType을 mimeType으로 할당한다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"이미지 메타정보가 image/로 시작하거나, getExtension 함수에서 반환값이 있거나, webp가 아니거나, avif가 아닐 경우엔, upstreamType을 쓰는데 buffer에서 추출한 값이나 이미지 메타정보의 contentType이 할당된다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"나머지는 JPEG로 할당된다.\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"pre\",null,{\"className\":\"language-ts\",\"children\":[\"$\",\"code\",null,{\"className\":\"language-ts code-highlight\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L776-L788\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" previouslyCachedImage \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"getPreviouslyCachedImageOrNull\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  imageUpstream\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  opts\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"previousCacheEntry\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"previouslyCachedImage\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    buffer\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" previouslyCachedImage\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"buffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    contentType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    maxAge\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" opts\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?.\"}],\"previousCacheEntry\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?.\"}],\"cacheControl\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?.\"}],\"revalidate \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"||\"}],\" maxAge\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    etag\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" previouslyCachedImage\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"etag\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    upstreamEtag\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" previouslyCachedImage\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"upstreamEtag\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}]]}]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"전에 Cache가 됐던 이미지는 리턴처리한다.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"pre\",null,{\"className\":\"language-tsx\",\"children\":[\"$\",\"code\",null,{\"className\":\"language-tsx code-highlight\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L790-L841\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"try\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"let\"}],\" optimizedBuffer \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"optimizeImage\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      buffer\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" upstreamBuffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      contentType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      quality\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      width\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      concurrency\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token property-access\",\"children\":\"experimental\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token property-access\",\"children\":\"imgOptConcurrency\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      limitInputPixels\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token property-access\",\"children\":\"experimental\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token property-access\",\"children\":\"imgOptMaxInputPixels\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      sequentialRead\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token property-access\",\"children\":\"experimental\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token property-access\",\"children\":\"imgOptSequentialRead\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      timeoutInSeconds\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token property-access\",\"children\":\"experimental\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token property-access\",\"children\":\"imgOptTimeoutInSeconds\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token spread operator\",\"children\":\"...\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}]]}]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"optimizeImage를 통해 buffer를 받게된다 - 실험적 config도 보인다.\",\"\\n\",[\"$\",\"table\",null,{\"children\":[[\"$\",\"thead\",null,{\"children\":[\"$\",\"tr\",null,{\"children\":[[\"$\",\"th\",null,{\"children\":\"옵션명\"}],[\"$\",\"th\",null,{\"children\":\"기능 요약\"}]]}]}],[\"$\",\"tbody\",null,{\"children\":[[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"concurrency\"}]}],[\"$\",\"td\",null,{\"children\":\"이미지 동시 처리 개수 제한 (성능 관련)\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"limitInputPixels\"}]}],[\"$\",\"td\",null,{\"children\":\"이미지 크기 제한 (보안/안정성)\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"sequentialRead\"}]}],[\"$\",\"td\",null,{\"children\":\"순차 읽기 여부 설정 (I/O 호환성)\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"timeoutInSeconds\"}]}],[\"$\",\"td\",null,{\"children\":\"이미지 최적화 타임아웃 설정 (무한대기 방지)\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"같은 기능을 지원할 수도 있다.\"}],[\"$\",\"td\",null,{}]]}]]}]]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"optimizeimage\",\"children\":\"optimizeImage\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"이미지 최적화 함수\"}],\"\\n\"]}],\"\\n\",[\"$\",\"pre\",null,{\"className\":\"language-ts\",\"children\":[\"$\",\"code\",null,{\"className\":\"language-ts code-highlight\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// https://github.com/vercel/next.js/blob/canary/packages/next/src/server/image-optimizer.ts#L535-L590\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"export\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"function\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"optimizeImage\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  buffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  contentType\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  quality\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  width\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  height\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  concurrency\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  limitInputPixels\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  sequentialRead\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  timeoutInSeconds\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  buffer\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" Buffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  contentType\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"string\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  quality\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"number\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  width\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"number\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  height\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"number\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  concurrency\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"number\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"null\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  limitInputPixels\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"number\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  sequentialRead\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"boolean\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"null\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  timeoutInSeconds\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"number\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"Promise\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"\u003c\"}],\"Buffer\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"\u003e\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" sharp \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"getSharp\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"concurrency\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"//nextConfig.experimental.imgOptConcurrency\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" transformer \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"sharp\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"buffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    limitInputPixels\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// nextConfig.experimental.imgOptMaxInputPixels\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    sequentialRead\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" sequentialRead \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"??\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"undefined\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// nextConfig.experimental.imgOptSequentialRead\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"timeout\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      seconds\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" timeoutInSeconds \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"??\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"7\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// nextConfig.experimental.imgOptTimeoutInSeconds\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"rotate\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"height\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    transformer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"resize\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"width\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" height\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"else\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    transformer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"resize\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"width\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"undefined\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      withoutEnlargement\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"true\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"contentType \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"===\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"AVIF\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    transformer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"avif\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      quality\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" Math\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"max\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"quality \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"20\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"1\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      effort\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"3\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"else\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"contentType \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"===\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"WEBP\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    transformer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"webp\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" quality \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"else\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"contentType \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"===\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"PNG\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    transformer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"png\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" quality \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"else\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"contentType \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"===\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"JPEG\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    transformer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"jpeg\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" quality\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" mozjpeg\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"true\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" optimizedBuffer \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" transformer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"toBuffer\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" optimizedBuffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}]]}]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"여기서 sharp가 등장한다. \",[\"$\",\"code\",null,{\"children\":\"getSharp\"}],\"로 sharp가 있는지 없는지 검사한 후 sharp 라이브러리로 최적화한다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"sharp 라이브러리에서 지원하는 기능이라면 next도 실험적(canary)으로 검토 후 기능을 추가하는 것 같다.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"imageoptimizer\",\"children\":\"imageOptimizer\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"next/src/server/next-server.ts\"}],\"\\n\",[\"$\",\"pre\",null,{\"className\":\"language-ts\",\"children\":[\"$\",\"code\",null,{\"className\":\"language-ts code-highlight\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// \u003chttps://github.com/vercel/next.js/blob/canary/packages/next/src/server/next-server.ts#L750-L802\u003e\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"protected\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"imageOptimizer\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    req\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" NodeNextRequest\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    res\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" NodeNextResponse\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    paramsResult\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"import\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'./image-optimizer'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"ImageParamsResult\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    previousCacheEntry\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" IncrementalResponseCacheEntry \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"null\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"Promise\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"\u003c\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    buffer\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" Buffer\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    contentType\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"string\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    maxAge\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"number\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    upstreamEtag\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"string\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    etag\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"string\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"\u003e\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"\\t\",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// mimimal환경에선 지원 x\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"process\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"env\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"NEXT_MINIMAL\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"throw\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"Error\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'invariant: imageOptimizer should not be called in minimal mode'\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"else\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"\\t\\t\",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 동적으로 `image-optimizer` 모듈을 가져옴(최소 실행 환경 대비 최적화)\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" imageOptimizer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" fetchExternalImage\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" fetchInternalImage \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"require\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'./image-optimizer'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"as\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"typeof\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"import\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'./image-optimizer'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"\\t\\t\\t\\t\",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 내부 이미지일때 컨트롤할 req handler\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function-variable function\",\"children\":\"handleInternalReq\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        newReq\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" IncomingMessage\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        newRes\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" ServerResponse\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\u003e\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"newReq\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"url \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"===\"}],\" req\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"url\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"throw\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"Error\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token template-string\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"Invariant attempted to optimize _next/image itself\"}],[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}]]}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!\"}],[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"routerServerHandler\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"throw\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"Error\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token template-string\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"Invariant missing routerServerHandler\"}],[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}]]}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"routerServerHandler\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"newReq\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" newRes\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"\\t\\t\\t\",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// image url이 절대경로인지, 최종 이미지 URL\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" isAbsolute\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" href \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" paramsResult\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"\\t\\t\\t\",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 외부 이미지 URL이면 fetchExternalImage(href), 내부라면 fetchInternalImage\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" imageUpstream \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" isAbsolute\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"fetchExternalImage\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"href\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 내부 이미지라 mock 이미지를 보내는걸로? 잘 모르겠슴\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"fetchInternalImage\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            href\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            req\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"originalRequest\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"            res\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"originalResponse\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"            handleInternalReq\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"          \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"\\t\\t\",[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 이미지 최적화 로직 수행\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"imageOptimizer\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"imageUpstream\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" paramsResult\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        isDev\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"renderOpts\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"dev\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        previousCacheEntry\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}]]}]}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"2-캐싱\",\"children\":\"2. 캐싱\"}],\"\\n\",[\"$\",\"pre\",null,{\"className\":\"language-ts\",\"children\":[\"$\",\"code\",null,{\"className\":\"language-ts code-highlight\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"function\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"writeToCacheDir\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  dir\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"string\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  extension\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"string\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  maxAge\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"number\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  expireAt\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"number\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  buffer\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" Buffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  etag\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"string\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  upstreamEtag\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"string\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" filename \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"join\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    dir\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token template-string\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}],[\"$\",\"span\",null,{\"className\":\"token interpolation\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"$${\"}],\"maxAge\",[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"}\"}]]}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token interpolation\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"$${\"}],\"expireAt\",[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"}\"}]]}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token interpolation\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"$${\"}],\"etag\",[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"}\"}]]}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token interpolation\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"$${\"}],\"upstreamEtag\",[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"}\"}]]}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token interpolation\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"$${\"}],\"extension\",[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"}\"}]]}],[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}]]}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" promises\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"rm\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"dir\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" recursive\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"true\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" force\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"true\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"catch\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\u003e\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" promises\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"mkdir\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"dir\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\" recursive\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token boolean\",\"children\":\"true\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" promises\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"writeFile\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"filename\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" buffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}]]}]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"이런식으로 캐시 디렉토리에 저장한다.\\n/next/src/server/image-optimizer.ts | function handleNextImageRequest\"}],\"\\n\"]}],\"\\n\",[\"$\",\"pre\",null,{\"className\":\"language-ts\",\"children\":[\"$\",\"code\",null,{\"className\":\"language-ts code-highlight\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 이미지 최적화 캐시 인스턴스 생성(이때 경로가 캐시 경로가 생성된다)\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" imageOptimizerCache \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"ImageOptimizerCache\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  distDir\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"distDir\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  nextConfig\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}]]}]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"이런식으로 ImageOptimizerCache가 있는데, 이 클래스에서 새로운 인스턴스를 만들게되면,\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"/next/src/server/image-optimizer.ts | class ImageOptimizerCache\"}],\"\\n\",[\"$\",\"pre\",null,{\"className\":\"language-ts\",\"children\":[\"$\",\"code\",null,{\"className\":\"language-ts code-highlight\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"set\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    cacheKey\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token builtin\",\"children\":\"string\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    value\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" IncrementalCacheValue \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"null\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      cacheControl\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      cacheControl\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" CacheControl\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!\"}],[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"experimental\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"isrFlushToDisk\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"return\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"value\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?.\"}],\"kind \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!==\"}],\" CachedRouteKind\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"IMAGE\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"throw\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"Error\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'invariant attempted to set non-image to image-cache'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" revalidate \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\" cacheControl\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"?.\"}],\"revalidate\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"typeof\"}],\" revalidate \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"!==\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'number'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"throw\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"InvariantError\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'revalidate must be a number for image-cache'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"const\"}],\" expireAt \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"=\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      Math\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"max\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"revalidate\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"nextConfig\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"images\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"minimumCacheTTL\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"*\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"1000\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"+\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      Date\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"now\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"try\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"await\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"writeToCacheDir\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"join\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"this\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"cacheDir\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" cacheKey\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        value\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"extension\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        revalidate\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        expireAt\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        value\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"buffer\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        value\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"etag\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"        value\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"upstreamEtag\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"catch\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"err\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"{\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"      Log\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"error\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token template-string\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"Failed to write image to cache \"}],[\"$\",\"span\",null,{\"className\":\"token interpolation\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"$${\"}],\"cacheKey\",[\"$\",\"span\",null,{\"className\":\"token interpolation-punctuation punctuation\",\"children\":\"}\"}]]}],[\"$\",\"span\",null,{\"className\":\"token template-punctuation string\",\"children\":\"`\"}]]}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" err\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"    \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"  \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"}\"}],\"\\n\"]}]]}]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"이 set 함수가 실행되어, 지정된 디렉토리 내에 캐시된 이미지가 최적화된 이미지가 저장된다.\"}],\"\\n\"]}]]}],[\"$\",\"hr\",null,{\"className\":\"my-10\"}],[\"$\",\"$L13\",null,{}]]\n"])</script><script>self.__next_f.push([1,"10:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Next.js Image 어떻게 최적화 할까?\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"Image 최적화 과정과 Canary 버전에서 확인해보는 신기능?도 있었다.\"}],[\"$\",\"meta\",\"4\",{\"name\":\"keywords\",\"content\":\"gogleset,Next,Image\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:title\",\"content\":\"Next.js Image 어떻게 최적화 할까?\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:description\",\"content\":\"Image 최적화 과정과 Canary 버전에서 확인해보는 신기능?도 있었다.\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:site_name\",\"content\":\"https://gogleset.github.io\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"9\",{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",\"10\",{\"name\":\"twitter:title\",\"content\":\"Next.js Image 어떻게 최적화 할까?\"}],[\"$\",\"meta\",\"11\",{\"name\":\"twitter:description\",\"content\":\"Image 최적화 과정과 Canary 버전에서 확인해보는 신기능?도 있었다.\"}],[\"$\",\"link\",\"12\",{\"rel\":\"icon\",\"href\":\"/favicon-32x32.png\"}],[\"$\",\"link\",\"13\",{\"rel\":\"apple-touch-icon\",\"href\":\"/apple-touch-icon.png\"}]]\n3:null\n"])</script></body></html>